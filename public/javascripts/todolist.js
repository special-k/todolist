(function(){var t,e,o,n={}.hasOwnProperty,i=function(t,e){function o(){this.constructor=t}for(var i in e)n.call(e,i)&&(t[i]=e[i]);return o.prototype=e.prototype,t.prototype=new o,t.__super__=e.prototype,t};window.start=function(){var t;return t=new o(document.one("todoapp"))},o=function(t){function e(t){this.dom=t,e.__super__.constructor.apply(this,arguments),this.addManager("listManager",new ListManager),this.addManager("panelsManager",new TodolistPanelsManager)}return i(e,t),e}(RT.Stratum),glob.TodolistPanelsManager=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return i(e,t),e.prototype.init=function(){return e.__super__.init.apply(this,arguments),this.setPanel("todoList",document.one("todo-list"))},e}(RT.ControlsPanelsManager),glob.ListManager=function(t){function e(){document.one("new-todo").bi(RTC.KEYUP,"onNewTodoAdd",{context:this}),window.bi(RTC.HASHCHANGE,"onHashChange",{context:this}),this.todoItems={}}return i(e,t),e.prototype.managers=["panelsManager"],e.prototype.panelsManagerLoaded=function(){return this.statusBarEl=RT.statusBar().bi("onRemoveCompleted","onRemoveCompleted",{context:this}),this.stratum.dom.add(this.statusBarEl),this.makeAction(window.location.href.split("#")[1]),this.updateItemsCount()},e.prototype.onHashChange=function(t,e){return this.makeAction(e.newURL.split("#")[1])},e.prototype.makeAction=function(t){var e,o,n,i,s,r,a,d,u,c,l,h,p;switch(this.panelsManager.clear("todoList"),t){case"/active":for(this.viewMode="active",this.statusBarEl.selectActiveOnly(),d=RT.Storage.getObjectsByPath("todoItems"),l=[],o=0,s=d.length;s>o;o++)e=d[o],l.push(e.isChecked?void 0:this.panelsManager.append("todoList",this.getOrCreateItem(e)));return l;case"/completed":for(this.viewMode="completed",this.statusBarEl.selectCompletedOnly(),u=RT.Storage.getObjectsByPath("todoItems"),h=[],n=0,r=u.length;r>n;n++)e=u[n],h.push(e.isChecked?this.panelsManager.append("todoList",this.getOrCreateItem(e)):void 0);return h;default:for(this.viewMode="all",this.statusBarEl.selectAll(),c=RT.Storage.getObjectsByPath("todoItems"),p=[],i=0,a=c.length;a>i;i++)e=c[i],p.push(this.panelsManager.append("todoList",this.getOrCreateItem(e)));return p}},e.prototype.onNewTodoAdd=function(t,e){var o,n;return n=t.value.trim(),13===e.keyCode&&""!==n?(o={body:n,isChecked:!1},RT.Storage.pushObject("todoItems",o),this.panelsManager.append("todoList",this.getOrCreateItem(o)),t.value="",this.updateItemsCount()):void 0},e.prototype.getOrCreateItem=function(t){var e;return e=this.todoItems[t.id],null==e&&(e=RT.todoItem(t).bi("onDone","onDone",{context:this}).bi("onComback","onComback",{context:this}).bi("onDelete","onDelete",{context:this}).bi("onEdit","onEdit",{context:this}),this.todoItems[t.id]=e),e},e.prototype.onDone=function(t){return RT.Storage.set(t.id,{id:t.id,body:t.body,isChecked:!0}),"active"===this.viewMode&&t.removeSelf(),this.updateItemsCount()},e.prototype.onComback=function(t){return RT.Storage.set(t.id,{id:t.id,body:t.body,isChecked:!1}),this.updateItemsCount()},e.prototype.onDelete=function(t){return RT.Storage["delete"](t.id),t.removeSelf(),delete this.todoItems[t.id],this.updateItemsCount()},e.prototype.onEdit=function(t){return RT.Storage.set(t.id,{id:t.id,body:t.body,isChecked:t.isChecked})},e.prototype.updateItemsCount=function(){return this.statusBarEl.setCount(RT.Storage.getObjectsByPath("todoItems").filter(function(t){return!t.isChecked}).length),this.statusBarEl.setCompletedCount(RT.Storage.getObjectsByPath("todoItems").filter(function(t){return t.isChecked}).length)},e.prototype.onRemoveCompleted=function(){var t,e,o,n;for(n=RT.Storage.getObjectsByPath("todoItems").filter(function(t){return t.isChecked}),e=0,o=n.length;o>e;e++)t=n[e],RT.Storage["delete"](t.id);return this.updateItemsCount(),this.makeAction(window.location.href.split("#")[1])},e}(RT.BaseManager),e=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return i(e,t),e.register("todoItem"),e.prototype.isMain=!0,e.prototype.createDom=function(t){return this.li().bi(RTC.DBLCLICK,"onStartEdit",{context:t}).add(function(){return this.div({"class":"view"},function(){return this.input({"class":"toggle",type:"checkbox"}).setas("checkboxEl").bi(RTC.CHANGE,"onChange",{context:t}),this.label(function(){return this.tn(t.body).setas("bodyEl")}),this.button({"class":"destroy"}).bi(RTC.CLICK,"onDeleteFire",{context:t})}),this.input({"class":"edit",value:t.body}).setas("editField").bi(RTC.CHANGE,"onFinishEdit",{context:t})})},e.prototype.init=function(){return window.bi(RTC.CLICK,"stopEdit",{context:this}),this.isChecked?(this.checkboxEl.checked=!0,this.dom.addCls("completed")):void 0},e.prototype.onChange=function(t){return t.checked?(this.fire("onDone"),this.isChecked=!0):(this.fire("onComback"),this.isChecked=!1),this.dom.togCls("completed")},e.prototype.onDeleteFire=function(){return this.fire("onDelete")},e.prototype.onStartEdit=function(t,e){return e.preventDefault(),this.dom.addCls("editing"),this.editField.focus(),this.editField.value="",this.editField.value=this.body},e.prototype.onFinishEdit=function(t){return this.body=t.value,this.bodyEl.nodeValue=t.value,this.dom.remCls("editing"),this.fire("onEdit")},e.prototype.stopEdit=function(){return this.dom.remCls("editing")},e}(RedTeaWidget),t=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return i(e,t),e.register("statusBar"),e.prototype.isMain=!0,e.prototype.createDom=function(){return this.footer({id:"footer"},function(){return this.span({id:"todo-count"},function(){return this.strong(function(){return this.tn("0").setas("todoCountEl"),this.tn(" item left")})}),this.ul({id:"filters"},function(){return this.li(function(){return this.a({href:"#/"}).setas("allButton").add(function(){return this.tn("All")})}),this.li(function(){return this.a({href:"#/active"}).setas("activeButton").add(function(){return this.tn("Active")})}),this.li(function(){return this.a({href:"#/completed"}).setas("completedButton").add(function(){return this.tn("Completed")})})})})},e.prototype.init=function(){var t;return t=this,this.removeCompletedButton=RT.button({id:"clear-completed"}).bi(RTC.CLICK,"onRemoveCompletedFire",{context:this}).add(function(){return this.tn("Clear completed ("),this.tn("0").setas("completedCountEl",t),this.tn(")")})},e.prototype.selectAll=function(){return this.selectItem(this.allButton)},e.prototype.selectActiveOnly=function(){return this.selectItem(this.activeButton)},e.prototype.selectCompletedOnly=function(){return this.selectItem(this.completedButton)},e.prototype.selectItem=function(t){return null!=this.selectedItem&&this.selectedItem.remCls("selected"),t.addCls("selected"),this.selectedItem=t},e.prototype.setCount=function(t){return this.todoCountEl.nodeValue=t},e.prototype.setCompletedCount=function(t){return this.completedCountEl.nodeValue=t,t>0?this.dom.add(this.removeCompletedButton):this.removeCompletedButton.removeSelf()},e.prototype.onRemoveCompletedFire=function(){return this.fire("onRemoveCompleted")},e}(RedTeaWidget)}).call(this);
