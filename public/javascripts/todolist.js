(function(){var t={}.hasOwnProperty,e=function(e,o){function n(){this.constructor=e}for(var s in o)t.call(o,s)&&(e[s]=o[s]);return n.prototype=o.prototype,e.prototype=new n,e.__super__=o.prototype,e};glob.Todolist=function(t){function o(){var t;o.__super__.constructor.apply(this,arguments),t=this,document.body.append(function(){return this.section({id:"todoapp"}).setas("dom",t).append(function(){return this.header({id:"header"},function(){return this.h1(function(){return this.tn("todolist")}),this.input({id:"new-todo",placeholder:"What needs to be done?",autofocus:""})}),this.section({style:"display: block;",id:"main"},function(){return this.input({id:"toggle-all",type:"checkbox"}),this.ul({id:"todo-list"}).setas("todoListEl",t)})}),this.aside({"class":"learn"},function(){return this.header(function(){return this.h3(function(){return this.tn("RedTea")}),this.span({"class":"source-links"},function(){return this.h5(function(){return this.tn("Example")}),this.a({href:"https://github.com/special-k/todolist"},function(){return this.tn("Source")})})})}),this.footer({id:"info"},function(){return this.p(function(){return this.tn("Double-click to edit a todo")}),this.p(function(){return this.tn("Written by "),this.a({href:"https://github.com/special-k"},function(){return this.tn("Kirill Jakovlev")})})})}),this.addManager("listManager",new ListManager),this.addManager("panelsManager",new TodolistPanelsManager),this.addManager("storageManager",new StorageManager)}return e(o,t),o}(RT.Stratum),glob.TodolistPanelsManager=function(t){function o(){return o.__super__.constructor.apply(this,arguments)}return e(o,t),o.prototype.init=function(){return o.__super__.init.apply(this,arguments),this.setPanel("todoList",this.stratum.todoListEl)},o}(RT.ControlsPanelsManager),glob.StorageManager=function(t){function o(){this.todoItems=new RT.Storage("todoItems")}return e(o,t),o}(RT.BaseManager),glob.ListManager=function(t){function o(){var t;t=new RT.SimpleSyncAnticipant,this.bi("panelsManagerLoaded","managersLoaded",{through:t}),this.bi("storageManagerLoaded","managersLoaded",{through:t}),document.one("new-todo").bi(RTC.KEYUP,"onNewTodoAdd",{context:this}),document.one("toggle-all").sprm("checked",!1).bi(RTC.CHANGE,"onToggleAll",{context:this}),window.bi(RTC.HASHCHANGE,"onHashChange",{context:this}),this.todoItems={},this.statusBarEl=RT.statusBar().bi("onRemoveCompleted","onRemoveCompleted",{context:this}),this.mainEl=document.one("main")}return e(o,t),o.prototype.managers=["panelsManager","storageManager"],o.prototype.managersLoaded=function(){return this.storage=this.storageManager.todoItems,this.storage.bi("onSet","onSetTodoItem",{context:this}),this.storage.bi("onRemove","onRemoveTodoItem",{context:this}),this.makeAction(),this.updateItemsCount()},o.prototype.onHashChange=function(){return this.makeAction()},o.prototype.makeAction=function(){var t,e,o,n,s,i,r,a,h,u,d,c,l;switch(this.panelsManager.clear("todoList"),window.location.href.split("#")[1]){case"/active":for(this.statusBarEl.selectActiveOnly(),a=this.storage.getObjects(function(t){return!t.isChecked}),d=[],e=0,s=a.length;s>e;e++)t=a[e],d.push(this.panelsManager.append("todoList",this.getOrCreateItem(t)));return d;case"/completed":for(this.statusBarEl.selectCompletedOnly(),h=this.storage.getObjects(function(t){return t.isChecked}),c=[],o=0,i=h.length;i>o;o++)t=h[o],c.push(this.panelsManager.append("todoList",this.getOrCreateItem(t)));return c;default:for(this.statusBarEl.selectAll(),u=this.storage.getObjects(),l=[],n=0,r=u.length;r>n;n++)t=u[n],l.push(this.panelsManager.append("todoList",this.getOrCreateItem(t)));return l}},o.prototype.onSetTodoItem=function(t,e,o){var n;return n=this.todoItems[e],null!=n?n.update(o):n=this.createItem(o),this.makeAction(),this.updateItemsCount()},o.prototype.onRemoveTodoItem=function(t,e){return this.todoItems[e].removeSelf(),delete this.todoItems[e],this.updateItemsCount()},o.prototype.onNewTodoAdd=function(t,e){var o;return o=t.value.trim(),13===e.keyCode&&""!==o?(t.value="",this.storage.push({body:o,isChecked:!1})):void 0},o.prototype.onToggleAll=function(t){var e,o,n,s,i,r,a,h,u;if(t.checked){for(r=this.storage.getObjects(function(t){return!t.isChecked}),h=[],o=0,s=r.length;s>o;o++)e=r[o],e.isChecked=!0,h.push(this.storage.set(e.id,e));return h}for(a=this.storage.getObjects(function(t){return t.isChecked}),u=[],n=0,i=a.length;i>n;n++)e=a[n],e.isChecked=!1,u.push(this.storage.set(e.id,e));return u},o.prototype.getOrCreateItem=function(t){return this.todoItems[t.id]||this.createItem(t)},o.prototype.createItem=function(t){var e;return e=RT.todoItem(t).bi("onDone","onDone",{context:this}).bi("onComback","onComback",{context:this}).bi("onDelete","onDelete",{context:this}).bi("onEdit","onEdit",{context:this}),this.todoItems[t.id]=e,e},o.prototype.onDone=function(t){return this.storage.set(t.id,{id:t.id,body:t.body,isChecked:!0})},o.prototype.onComback=function(t){return this.storage.set(t.id,{id:t.id,body:t.body,isChecked:!1})},o.prototype.onDelete=function(t){return this.storage.remove(t.id)},o.prototype.onEdit=function(t,e){return this.storage.set(t.id,{id:t.id,body:e,isChecked:t.isChecked})},o.prototype.onRemoveCompleted=function(){var t,e,o,n,s;for(n=this.storage.getObjects(function(t){return t.isChecked}),s=[],e=0,o=n.length;o>e;e++)t=n[e],s.push(this.storage.remove(t.id));return s},o.prototype.updateItemsCount=function(){var t,e;return e=this.storage.getObjects(function(t){return!t.isChecked}).length,t=this.storage.getObjects(function(t){return t.isChecked}).length,this.statusBarEl.setCount(e),this.statusBarEl.setCompletedCount(t),0===e&&0===t?(this.statusBarEl.removeSelf(),this.mainEl.style.display="none"):this.statusBarEl.isAdded()?void 0:(this.stratum.dom.append(this.statusBarEl),this.mainEl.style.display="block")},o}(RT.BaseManager)}).call(this);
