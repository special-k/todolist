(function(){var t,e,n,o,i,r,s,u,a,h,c={}.hasOwnProperty,d=function(t,e){function n(){this.constructor=t}for(var o in e)c.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},p=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};glob.Todolist=function(t){function e(){e.__super__.constructor.apply(this,arguments),this.addManager("itemsManager",new n),this.addManager("routesManager",new r),document.body.append(this.list(function(){}))}return d(e,t),e}(RT.Stratum),n=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}var n;return d(e,t),n="todos-redtea",e.prototype.setStorageItems=function(t){return this.storageItems=t,this.bime(this.storageItems,"onItemAdded","onItemAdded"),this.bime(this.storageItems,"onItemChanged","onItemChanged"),this.loadItems()},e.prototype.onItemChanged=function(t,e,n,o){switch(n){case"finished":return this.asyncStore();case"deleted":if(o)return this.storageItems.remove(e),this.asyncStore()}},e.prototype.onItemAdded=function(t,e){return this.asyncStore()},e.prototype.scope=function(t){var e;switch(e=this.storageItems.items,t){case"/":return e;case"touched":return e.filter(function(t){return t.get("touched")});case"untouched":return e.filter(function(t){return!t.get("touched")});case"/active":return e.filter(function(t){return!t.get("finished")});case"/completed":return e.filter(function(t){return t.get("finished")})}},e.prototype.loadItems=function(){var t,e,o,i;if(this.asyncStoreLock=!0,localStorage.hasOwnProperty(n))for(i=JSON.parse(localStorage.getItem(n)),e=0,o=i.length;o>e;e++)t=i[e],this.storageItems.push(new RT.StorageItem({task:t.task,finished:t.finished,touched:!0},"both"));return this.asyncStoreLock=!1},e.prototype.createItem=function(t){return t?this.storageItems.push(new RT.StorageItem({task:t,finished:!1,touched:!0},"both")):void 0},e.prototype.deleteItem=function(t){return t?(this.storageItems.remove(t),this.asyncStore()):void 0},e.prototype.setAllDone=function(t){var e,n,o,i,r;if(t||this.scope("/completed").length===this.scope("/").length){for(i=this.scope("/"),r=[],n=0,o=i.length;o>n;n++)e=i[n],r.push(e.set("finished",t));return r}},e.prototype.asyncStore=function(){return this.asyncStoreLock?void 0:(this.asyncStoreLock=!0,setTimeout(function(t){return function(){return localStorage.setItem(n,JSON.stringify(t.scope("/").map(function(t){return{task:t.data.task,finished:t.data.finished}}))),t.asyncStoreLock=!1}}(this),10))},e}(RT.BaseManager),r=function(t){function e(){this.bime(window,RTC.HASHCHANGE,"onHashchange"),this.bi("onChangePath","onChangePath"),this.setPath(location.href)}return d(e,t),e.prototype.onHashchange=function(t,e){return this.setPath(e.newURL)},e.prototype.onChangePath=function(t,e){this.path=e},e.prototype.setPath=function(t){return t.match("#")?this.fire("onChangePath",t.substring(t.split("#",1)[0].length+1,t.length)):this.fire("onChangePath","/")},e}(RT.BaseManager),o=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return d(e,t),e.register("list"),e.prototype.managers=["itemsManager","routesManager"],e.prototype.itemsManagerLoaded=function(){return this.itemsManager.setStorageItems(this.getCollectionField("items"))},e.prototype.routesManagerLoaded=function(){return this.onChangePath(null,this.routesManager.path),this.bime(this.routesManager,"onChangePath","onChangePath")},e.prototype.createDom=function(t){return this.section({id:"todoapp"},function(){return this.h1(function(){return this.tn("\u0434\u0435\u043b\u0430")}),this.ul({id:"todo-list"}).setas("listEl",t).append(function(){return this.newItem()}),this.statusBar(function(){return this.tools()})})},e.prototype.append=function(t,e){var n,o,i,r;for(this.newAddedItems=[],this.addHelper(this.listEl,t,e),r=this.newAddedItems,o=0,i=r.length;i>o;o++)n=r[o],this.checkTouching(n);return this.asyncUpdateCount()},e.prototype.storageInit=function(){return this.bime(this.getCollectionField("items"),"onItemAdded","onItemAdded"),this.bime(this.getCollectionField("items"),"onItemChanged","onItemChanged")},e.prototype.onItemAdded=function(t,e){return null==e.widget?(this.append(function(){return this.item({storageItem:e})}),this.checkTouching(e),this.asyncUpdateCount()):this.newAddedItems.push(e)},e.prototype.onItemChanged=function(t,e,n,o){switch(n){case"touched":return o?this.append(e.widget):e.widget.removeSelf();case"finished":return this.asyncUpdateCount(),this.checkTouching(e);case"deleted":if(o&&null!=e.widget)return e.widget.destroy(),this.asyncUpdateCount()}},e.prototype.onChangePath=function(t,e){return this.itemsManager.scope("touched").forEach(function(t){return t.set("touched",!1)}),this.itemsManager.scope(e).forEach(function(t){return t.set("touched",!0)}),this.storageItem.get("statusBar").first().get("widgets").first().set("path",e)},e.prototype.asyncUpdateCount=function(){return this.asyncCountLock?void 0:(this.asyncCountLock=!0,setTimeout(function(t){return function(){return t.updateStatusBar(),t.asyncCountLock=!1}}(this),10))},e.prototype.updateStatusBar=function(){return this.storageItem.get("statusBar").first().set("count",this.itemsManager.scope("/active").length),this.storageItem.get("newItem").first().set("count",this.itemsManager.scope("/active").length)},e.prototype.checkTouching=function(t){return this.routesManager?t.set("touched",p.call(this.itemsManager.scope(this.routesManager.path),t)>=0):void 0},e}(RT.Widget),e=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return d(e,t),e.register("item"),e.prototype.collectionName="items",e.prototype.pass="both",e.prototype.createDom=function(t){return this.li(function(){return this.checkbox({name:"finished"}),this.stringField({name:"task"}).setas("stringFieldEl",t),this.div({"class":"view"}).setas("viewEl",t).append(function(){return this.textBox({name:"task"}),this.button({"class":"destroy"}).setas("destroyEl",t)})})},e.prototype.init=function(){return this.viewMode(),this.checkFinished(this.storageItem.get("finished")),this.bime(this.destroyEl,RTC.CLICK,"onDestroy")},e.prototype.storageInit=function(){return this.bime(this.storageItem,"onFieldChanged","onFieldChanged")},e.prototype.onFieldChanged=function(t,e,n){switch(e){case"finished":return this.checkFinished(n);case"editing":if(n)return this.editMode();if(this.viewMode(),!this.storageItem.get("task"))return this.onDestroy()}},e.prototype.viewMode=function(){return this.stringFieldEl.removeSelf(),this.dom.append(this.viewEl)},e.prototype.editMode=function(){return this.viewEl.removeSelf(),this.dom.append(this.stringFieldEl)},e.prototype.checkFinished=function(t){return t?this.addCls("done"):this.remCls("done")},e.prototype.onDestroy=function(){return this.storageItem.set("deleted",!0)},e}(RT.Widget),i=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return d(e,t),e.register("newItem"),e.prototype.collectionName="newItem",e.prototype.managers=["itemsManager"],e.prototype.itemsManagerLoaded=function(){return this.bime(this.stringFieldEl,"onEnter","onEnter")},e.prototype.createDom=function(t){return this.li(function(){return this.checkbox({name:"finished"}).setas("checkboxEl",t),this.stringField({name:"task",placeholder:"\u0427\u0435 \u0434\u0435\u043b\u0430\u0442\u044c-\u0442\u043e, \u0430?"}).setas("stringFieldEl",t)})},e.prototype.init=function(){return this.addCls("newItem"),this.storageItem.set("task","")},e.prototype.onEnter=function(){return this.itemsManager.createItem(this.stringFieldEl.getValue()),this.storageItem.set("task","")},e.prototype.onFieldChanged=function(t,e,n){switch(e){case"finished":return this.itemsManager.setAllDone(n);case"count":return 0===n?this.storageItem.set("finished",!0):this.storageItem.set("finished",!1)}},e}(e),t=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return d(e,t),e.register("checkbox"),e.prototype.createDom=function(t){return this.input({type:"checkbox","class":"checkbox"})},e.prototype.init=function(t){return this.name=t.name,this.setValue(this.storageItem.get(this.name)),this.bime(this.dom,RTC.CHANGE,"onChange"),this.dom.stopProp(RTC.DBLCLICK)},e.prototype.storageInit=function(){return this.bime(this.storageItem,"onFieldChanged","onFieldChanged")},e.prototype.onFieldChanged=function(t,e,n){return e===this.name?this.setValue(n):void 0},e.prototype.getValue=function(){return this.dom.checked},e.prototype.setValue=function(t){return t?this.dom.checked=!0:this.dom.checked=!1},e.prototype.onChange=function(t,e){return this.storageItem.set(this.name,this.dom.checked)},e}(RT.Widget),u=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return d(e,t),e.register("stringField"),e.prototype.createDom=function(t,e){return this.input({type:"text","class":"stringField",placeholder:e.placeholder||""})},e.prototype.init=function(t){return this.name=t.name,this.setValue(this.storageItem.get(this.name)),this.bime(this.dom,RTC.KEYUP,"onKeyUp"),this.bime(this.dom,RTC.CHANGE,"onChange"),this.bime(this.dom,"blur","setEditing")},e.prototype.storageInit=function(){return this.bime(this.storageItem,"onFieldChanged","onFieldChanged")},e.prototype.onFieldChanged=function(t,e,n){switch(e){case this.name:return this.setValue(n);case"editing":return this.onEditing(n)}},e.prototype.onChange=function(t,e){return this.storageItem.set(this.name,this.getValue())},e.prototype.onKeyUp=function(t,e){return 13===e.keyCode?(this.setEditing(),this.fire("onEnter")):void 0},e.prototype.getValue=function(){return this.dom.value},e.prototype.setValue=function(t){return this.dom.value=t},e.prototype.setEditing=function(){return this.storageItem.set("editing",!1)},e.prototype.onEditing=function(t){return t?(this.dom.focus(),this.dom.setSelectionRange(this.dom.value.length,this.dom.value.length)):void 0},e}(RT.Widget),a=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return d(e,t),e.register("textBox"),e.prototype.createDom=function(t){return this.div({"class":"textBox"},function(){return this.tn("").setas("body",t)})},e.prototype.init=function(t){return this.name=t.name,this.setValue(this.storageItem.get(this.name)),this.bime(this.dom,RTC.DBLCLICK,"setEditing")},e.prototype.storageInit=function(){return this.bime(this.storageItem,"onFieldChanged","onFieldChanged")},e.prototype.onFieldChanged=function(t,e,n){return e===this.name?this.setValue(n):void 0},e.prototype.setValue=function(t){return this.body.nodeValue=t,t},e.prototype.setEditing=function(){return this.storageItem.set("editing",!0)},e}(RT.Widget),s=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return d(e,t),e.register("statusBar"),e.prototype.collectionName="statusBar",e.prototype.createDom=function(t){return this.footer({id:"footer"},function(){return this.span({id:"todo-count"},function(){return this.tn("0").setas("todoCountEl",t)})})},e.prototype.storageInit=function(){return this.bime(this.storageItem,"onFieldChanged","onFieldChanged")},e.prototype.onFieldChanged=function(t,e,n){return"count"===e?this.todoCountEl.nodeValue=n:void 0},e}(RT.Widget),h=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return d(e,t),e.register("tools"),e.prototype.preinit=function(){return this.buttons={}},e.prototype.createDom=function(t){return this.ul({id:"filters"},function(){return this.li(function(){return this.a({href:"#/"}).setas("/",t.buttons).add(function(){return this.tn("\u0432\u0441\u0435")})}),this.li(function(){return this.a({href:"#/active"}).setas("/active",t.buttons).add(function(){return this.tn("\u0430\u043a\u0442\u0438\u0432\u043d\u044b\u0435")})}),this.li(function(){return this.a({href:"#/completed"}).setas("/completed",t.buttons).add(function(){return this.tn("\u0441\u0434\u0435\u043b\u0430\u043d\u043d\u044b\u0435")})})})},e.prototype.storageInit=function(){return this.bime(this.storageItem,"onFieldChanged","onFieldChanged")},e.prototype.onFieldChanged=function(t,e,n){return"path"===e?this.selectButton(this.buttons[n]||this.buttons["/"]):void 0},e.prototype.selectButton=function(t){return null!=this.selectedButton&&this.selectedButton.remCls("selected"),t.addCls("selected"),this.selectedButton=t},e}(RT.Widget)}).call(this);
