(function(){var t,e,o={}.hasOwnProperty,n=function(t,e){function n(){this.constructor=t}for(var i in e)o.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};glob.Todolist=function(t){function e(t){this.dom=t,e.__super__.constructor.apply(this,arguments),this.addManager("listManager",new ListManager),this.addManager("panelsManager",new TodolistPanelsManager),this.addManager("storageManager",new StorageManager),document.body.add(function(){return this.aside({"class":"learn"},function(){return this.header(function(){return this.h3(function(){return this.tn("RedTea")}),this.span({"class":"source-links"},function(){return this.h5(function(){return this.tn("Example")}),this.a({href:"https://github.com/special-k/todolist"},function(){return this.tn("Source")})})})})})}return n(e,t),e}(RT.Stratum),glob.TodolistPanelsManager=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return n(e,t),e.prototype.init=function(){return e.__super__.init.apply(this,arguments),this.setPanel("todoList",document.one("todo-list"))},e}(RT.ControlsPanelsManager),glob.StorageManager=function(t){function e(){this.todoItems=new RT.Storage("todoItems")}return n(e,t),e}(RT.BaseManager),glob.ListManager=function(t){function e(){var t;t=new RT.SimpleSyncAnticipant,this.bi("panelsManagerLoaded","managersLoaded",{through:t}),this.bi("storageManagerLoaded","managersLoaded",{through:t}),document.one("new-todo").bi(RTC.KEYUP,"onNewTodoAdd",{context:this}),document.one("toggle-all").sprm("checked",!1).bi(RTC.CHANGE,"onToggleAll",{context:this}),window.bi(RTC.HASHCHANGE,"onHashChange",{context:this}),this.todoItems={},this.statusBarEl=RT.statusBar().bi("onRemoveCompleted","onRemoveCompleted",{context:this}),this.mainEl=document.one("main")}return n(e,t),e.prototype.managers=["panelsManager","storageManager"],e.prototype.managersLoaded=function(){return this.storage=this.storageManager.todoItems,this.storage.bi("onSet","onSetTodoItem",{context:this}),this.storage.bi("onRemove","onRemoveTodoItem",{context:this}),this.makeAction(),this.updateItemsCount()},e.prototype.onHashChange=function(){return this.makeAction()},e.prototype.makeAction=function(){var t,e,o,n,i,s,r,a,u,d,h,c,l;switch(this.panelsManager.clear("todoList"),window.location.href.split("#")[1]){case"/active":for(this.statusBarEl.selectActiveOnly(),a=this.storage.getObjects(function(t){return!t.isChecked}),h=[],e=0,i=a.length;i>e;e++)t=a[e],h.push(this.panelsManager.append("todoList",this.getOrCreateItem(t)));return h;case"/completed":for(this.statusBarEl.selectCompletedOnly(),u=this.storage.getObjects(function(t){return t.isChecked}),c=[],o=0,s=u.length;s>o;o++)t=u[o],c.push(this.panelsManager.append("todoList",this.getOrCreateItem(t)));return c;default:for(this.statusBarEl.selectAll(),d=this.storage.getObjects(),l=[],n=0,r=d.length;r>n;n++)t=d[n],l.push(this.panelsManager.append("todoList",this.getOrCreateItem(t)));return l}},e.prototype.onSetTodoItem=function(t,e,o){var n;return n=this.todoItems[e],null!=n?n.update(o):n=this.createItem(o),this.makeAction(),this.updateItemsCount()},e.prototype.onRemoveTodoItem=function(t,e){return this.todoItems[e].removeSelf(),delete this.todoItems[e],this.updateItemsCount()},e.prototype.onNewTodoAdd=function(t,e){var o;return o=t.value.trim(),13===e.keyCode&&""!==o?(t.value="",this.storage.push({body:o,isChecked:!1})):void 0},e.prototype.onToggleAll=function(t){var e,o,n,i,s,r,a,u,d;if(t.checked){for(r=this.storage.getObjects(function(t){return!t.isChecked}),u=[],o=0,i=r.length;i>o;o++)e=r[o],e.isChecked=!0,u.push(this.storage.set(e.id,e));return u}for(a=this.storage.getObjects(function(t){return t.isChecked}),d=[],n=0,s=a.length;s>n;n++)e=a[n],e.isChecked=!1,d.push(this.storage.set(e.id,e));return d},e.prototype.getOrCreateItem=function(t){return this.todoItems[t.id]||this.createItem(t)},e.prototype.createItem=function(t){var e;return e=RT.todoItem(t).bi("onDone","onDone",{context:this}).bi("onComback","onComback",{context:this}).bi("onDelete","onDelete",{context:this}).bi("onEdit","onEdit",{context:this}),this.todoItems[t.id]=e,e},e.prototype.onDone=function(t){return this.storage.set(t.id,{id:t.id,body:t.body,isChecked:!0})},e.prototype.onComback=function(t){return this.storage.set(t.id,{id:t.id,body:t.body,isChecked:!1})},e.prototype.onDelete=function(t){return this.storage.remove(t.id)},e.prototype.onEdit=function(t,e){return this.storage.set(t.id,{id:t.id,body:e,isChecked:t.isChecked})},e.prototype.onRemoveCompleted=function(){var t,e,o,n,i;for(n=this.storage.getObjects(function(t){return t.isChecked}),i=[],e=0,o=n.length;o>e;e++)t=n[e],i.push(this.storage.remove(t.id));return i},e.prototype.updateItemsCount=function(){var t,e;return e=this.storage.getObjects(function(t){return!t.isChecked}).length,t=this.storage.getObjects(function(t){return t.isChecked}).length,this.statusBarEl.setCount(e),this.statusBarEl.setCompletedCount(t),0===e&&0===t?(this.statusBarEl.removeSelf(),this.mainEl.style.display="none"):this.statusBarEl.isAdded()?void 0:(this.stratum.dom.add(this.statusBarEl),this.mainEl.style.display="block")},e}(RT.BaseManager),e=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return n(e,t),e.register("todoItem"),e.prototype.isMain=!0,e.prototype.createDom=function(t){return this.li().bi(RTC.DBLCLICK,"onStartEdit",{context:t}).add(function(){return this.div({"class":"view"},function(){return this.input({"class":"toggle",type:"checkbox"}).setas("checkboxEl").bi(RTC.CHANGE,"onChange",{context:t}),this.label(function(){return this.tn(t.body).setas("bodyEl")}),this.button({"class":"destroy"}).bi(RTC.CLICK,"onDeleteFire",{context:t})}),this.input({"class":"edit",value:t.body}).setas("editField").bi(RTC.CHANGE,"onFinishEdit",{context:t})})},e.prototype.init=function(t){return window.bi(RTC.CLICK,"stopEdit",{context:this}),this.update(t)},e.prototype.update=function(t){return this.isChecked=t.isChecked,this.isChecked?(this.checkboxEl.checked=!0,this.dom.addCls("completed")):(this.checkboxEl.checked=!1,this.dom.remCls("completed")),this.body=t.body,this.bodyEl.nodeValue=this.body,this.editField.value=this.body},e.prototype.onStartEdit=function(t,e){return e.preventDefault(),this.dom.addCls("editing"),this.editField.focus(),this.editField.value="",this.editField.value=this.body},e.prototype.stopEdit=function(){return this.dom.remCls("editing")},e.prototype.onChange=function(t){return this.fire(t.checked?"onDone":"onComback")},e.prototype.onDeleteFire=function(){return this.fire("onDelete")},e.prototype.onFinishEdit=function(t){return this.fire("onEdit",t.value),this.stopEdit()},e}(RedTeaWidget),t=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return n(e,t),e.register("statusBar"),e.prototype.isMain=!0,e.prototype.createDom=function(){return this.footer({id:"footer"},function(){return this.span({id:"todo-count"},function(){return this.strong(function(){return this.tn("0").setas("todoCountEl"),this.tn(" item left")})}),this.ul({id:"filters"},function(){return this.li(function(){return this.a({href:"#/"}).setas("allButton").add(function(){return this.tn("All")})}),this.li(function(){return this.a({href:"#/active"}).setas("activeButton").add(function(){return this.tn("Active")})}),this.li(function(){return this.a({href:"#/completed"}).setas("completedButton").add(function(){return this.tn("Completed")})})})})},e.prototype.init=function(){var t;return t=this,this.removeCompletedButton=RT.button({id:"clear-completed"}).bi(RTC.CLICK,"onRemoveCompletedFire",{context:this}).add(function(){return this.tn("Clear completed ("),this.tn("0").setas("completedCountEl",t),this.tn(")")})},e.prototype.selectAll=function(){return this.selectItem(this.allButton)},e.prototype.selectActiveOnly=function(){return this.selectItem(this.activeButton)},e.prototype.selectCompletedOnly=function(){return this.selectItem(this.completedButton)},e.prototype.selectItem=function(t){return null!=this.selectedItem&&this.selectedItem.remCls("selected"),t.addCls("selected"),this.selectedItem=t},e.prototype.setCount=function(t){return this.todoCountEl.nodeValue=t},e.prototype.setCompletedCount=function(t){return this.completedCountEl.nodeValue=t,t>0?this.dom.add(this.removeCompletedButton):this.removeCompletedButton.removeSelf()},e.prototype.onRemoveCompletedFire=function(){return this.fire("onRemoveCompleted")},e}(RedTeaWidget)}).call(this);
